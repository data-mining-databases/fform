<head>
    <style>
        #form-container {
            display: flex;
            align-items: center;
        }

        #form-body {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        #form-questions-container {
            width: 50vw;
            display: flex;
            align-self: center;
        }

        #form-questions {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        #form-header {
            display: flex;
            width: 50vw;
            justify-content: space-between;
        }

        #form-bio {
            display: flex;
            flex-direction: column;
        }

        #form-questions.label {
            background-color: cyan;
        }

        #check-modal {
            display: flex;
            flex-direction: column;
            align-items: center;
            top: 0;
            left: 0;
            position: absolute;
            width: 100vw;
            min-height: 100vh;
            visibility: hidden;
            background-color: rgba(240, 240, 240, 1.0);
            gap: 3vh;
        }

        #gbutton {
            position: absolute;
            visibility: hidden;
        }

        #score {
            visibility: hidden;

        }

        #score-container {
            visibility: hidden;
        }

        select {
            width: 25%;
            margin-bottom: 3%;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <form id="_form" enctype="multipart/form-data" method="POST"
        action="https://script.google.com/macros/s/AKfycbwj7YDErOBfejzqm-qYJ5tzMkpEhNhQOYijDvqTi4L7e9-vG28RcyLV6V7aQJKvLjHWbA/exec">
        <div id="form-container">
            <div id="form-body">
                <div id="form-header">
                    <div id="form-bio">
                        <label>ФИО</label>
                        <input name="username" required>
                        <input id="fuid" name="form_user_id" hidden required>
                    </div>
                    <div id="form-name">
                        <div id="score"></div>
                    </div>
                </div>

                <input id="sbutton" type="submit" disabled>
                <div id="form-questions-container">
                    <div id="form-questions">
                    </div>
                </div>
                <input id="gbutton" value="Получить вопросы" type="button" onClick="genForm()">
            </div>
        </div>
    </form>
    <div id="score-container">
        <table id="score-list">
            <tr>
                <th>ФИО</th>
                <th>Результат</th>
            </tr>
        </table>

    </div>
    <div id="check-modal">
        <h3>Отправить?</h3>
        <div>Перепройти тест будет нельзя</div>
        <div>
            <button onClick="submitForm()">Да</button>
            <button onClick="closeForm()">Нет</button>
        </div>
    </div>
</body>

<script>

    let addr = "https://script.google.com/macros/s/AKfycbwj7YDErOBfejzqm-qYJ5tzMkpEhNhQOYijDvqTi4L7e9-vG28RcyLV6V7aQJKvLjHWbA/exec";

    let uuid = crypto.randomUUID();
    let mycookie = /form_user_id=(.+)(?:[\s]|$)/gm;
    let check = mycookie.exec(document.cookie);
    let fuid = document.getElementById("fuid");
    if (null === check) {
        document.cookie = `form_user_id=${uuid}; expires=Fri, 31 Dec 9999 23:59:59 GMT`;
        fuid.value = uuid;
    } else {
        fuid.value = check[1];

        const queryString = window.location.search;
        let shsc = /(?:showscore)=(.+?)(?:&|$)/gm;

        const arr = [...queryString.matchAll(shsc)];

        if (arr.length && arr[0][1]) {
            document.getElementById("score-container").style.visibility = "visible";
            getAllScore().then(v => v.forEach(vv => {
                let tbody = document.getElementById("score-list").getElementsByTagName('tbody')[0]

                let row = tbody.insertRow();
                row.insertCell().innerText =  vv[0];
                row.insertCell().innerText =  `${vv[1]}/30`;

            }));
        } else {
            getScore().then(data => {
                console.log(data);
                if (data.result && data.result != -1) {
                    displayScore(data.result[0], data.result[1]);
                } else {
                    let gb = document.getElementById("gbutton");
                    gb.style.visibility = "visible";
                    gb.style.position = "relative";
                }
            });
        }
    }

    let fqc = document.getElementById("form-questions-container");

    let ff = document.getElementById("_form");
    ff.addEventListener("submit", formHandler);

    let cm = document.getElementById("check-modal");
    let scr = document.getElementById("score");

    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min) + min);
    }

    function displayScore(bio, score) {
        scr.style.visibility = "visible";
        scr.innerText = `${bio}: ${score}/30`;
    }

    async function getAllScore() {
        let rs = await fetch(addr, {
            method: 'POST',
            body: JSON.stringify({
                "type": "GETALLS"
            })
        }
        );
        let data = await rs.json();
        return data;
    }

    async function getScore() {
        let rs = await fetch(addr, {
            method: 'POST',
            body: JSON.stringify({
                "type": "GETSCORE",
                "uid": fuid.value
            })
        }
        );
        let data = await rs.json();
        return data;
    }

    async function submitForm() {
        cm.style.visibility = "hidden";
        fqc.style.visibility = "hidden";
        fqc.style.position = "absolute";
        document.getElementById("sbutton").disabled = true;
        let fd = new FormData(ff);
        let rs = await fetch(addr, {
            method: "POST",
            body: fd
        }
        );
        let data = await rs.json();
        displayScore(data.result[0], data.result[1]);
    }

    async function closeForm() {
        cm.style.visibility = "hidden";
        ff.style.overflowY = null;
        ff.style.height = null;
    }

    async function formHandler(e) {
        e.preventDefault();
        ff.style.overflowY = "clip";
        ff.style.height = "90vh";
        cm.style.visibility = "visible";
    }

    async function genForm() {
        for (i = 0; i < 30; i++) {
            let idx = getRandomInt(0, 104);
            console.log(idx);
            getQuestion(idx);
        }
    }

    async function getQuestion(qid) {

        let rs = await fetch(addr, {
            method: 'POST',

            body: JSON.stringify({
                "type": "GETQ",
                "idx": qid
            })
        }
        );

        let data = await rs.json();
        let q = JSON.parse(data);
        console.log(q);

        var f = document.getElementById("form-questions");
        var sb = document.getElementById("sbutton");
        sb.disabled = false;
        var gb = document.getElementById("gbutton");
        gb.style.visibility = "hidden";
        var qLabel = document.createElement("label");
        qLabel.innerText = q.question;
        var sel = document.createElement("select");

        sel.id = qid;
        sel.name = "question" + qid;

        q.options.forEach((v, idx) => {
            let o = document.createElement("option");
            o.innerText = v;
            o.value = idx;
            sel.appendChild(o);
        });

        f.appendChild(qLabel);
        f.appendChild(sel);

    }






</script>